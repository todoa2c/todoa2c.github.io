<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: AppEngine | 技術情報棚卸し(平日限定)]]></title>
  <link href="http://todoa2c.github.io/blog/categories/appengine/atom.xml" rel="self"/>
  <link href="http://todoa2c.github.io/"/>
  <updated>2014-05-30T11:54:57+09:00</updated>
  <id>http://todoa2c.github.io/</id>
  <author>
    <name><![CDATA[Atsushi Kanaya (todoa2c)]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Codeshipを使ったApp Engineへの継続的デリバリー]]></title>
    <link href="http://todoa2c.github.io/blog/2014/05/30/codeship-appengine-continuous-delivery/"/>
    <updated>2014-05-30T11:13:17+09:00</updated>
    <id>http://todoa2c.github.io/blog/2014/05/30/codeship-appengine-continuous-delivery</id>
    <content type="html"><![CDATA[<p>IntelliJ IDEAからApp Engineへのデプロイが簡単にできることは以前書いたのですが、
自分のIntelliJ IDEAのローカルフォルダの情報がそのままデプロイされてしまうので、
コミットしていないコードがそのままデプロイされてしまう危険性があります。
また、デプロイの作業が自分しかできない、暗黙知化されるのも良くないわけです。</p>

<p>こういった問題の解決策として継続的デリバリーを行うべく、
実現できるサービスを探したところ、ありました。
<a href="https://www.codeship.io/">Codeship</a>というサービスです。</p>

<p>Codeshipは、扱えるコード、コードのホスト先だけでなく、
コードを動かすクラウド環境(AWSやDigital Oceanなど)も選べるし、その際に必要となる
デプロイやプロビジョニングツールも提供されており、
テストから環境構築してデプロイまでを一手に引き受けてくれるサービスです。</p>

<p>今回は、Bitbucketに置いてある自分のプライベートリポジトリを監視し、
コードのPushがあったタイミングでテストを行い、
かつmasterブランチに対するコミットがあった時点でApp Engineにデプロイする、
というところまでをやってみました。</p>

<p>基本的な実現方法は、下記をご参照ください。こっちの方が分かりやすいです。</p>

<p><a href="http://blog.codeship.io/2014/01/21/continuous-deployment-google-app-engine-bitbucket-python-django.html">Continuous Deployment for Django apps from Bitbucket to Google App Engine &ndash; Codeship</a></p>

<p>工夫した点は、設定面の工夫は特にありませんが、デプロイの仕方だけは少し工夫しています。
GitのブランチをGit-flow風にして、developを開発用ブランチ、masterをリリース用ブランチにして、
リリース時には、developの変更点をmasterにマージしてもらうようなPull Requestを
Bitbucket上で作成します。</p>

<p><img src="/images/contents/20140530-bitbucket-deploy-pr.png" alt="デプロイ用Pull Requestの変更点" /></p>

<p>こうすることで、どのコミットがリリースに含まれるかが、リリース用Pull Requestを見れば
一目瞭然になるわけです。</p>

<p>※アイデアは <a href="http://d.hatena.ne.jp/naoya/20140502/1399027655">GitHub 時代のデプロイ戦略 &ndash; naoyaのはてなダイアリー</a>です。</p>

<p>あとはデプロイはCodeshipにお願いすると。</p>

<p><img src="/images/contents/20140530-codeship-deploy.png" alt="Codeshipによるデプロイ" /></p>

<p>これでBitbucket上からのリリースもできるようになり、非常に快適になりました。
あとは、今はまだステージング環境のようなものを用意していないのですが、
developブランチにコミットがあった場合にステージング環境にデプロイもする、という設定を
追加すると良いかもしれないですね。</p>

<p>Codeshipは1ヶ月に50回のビルドまでであれば無料で使うことが出来ますので、
ご興味のある方は、是非是非お試しください。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[App Engine/Pythonでハマった初心者向けトラップ]]></title>
    <link href="http://todoa2c.github.io/blog/2014/05/22/appengine-python-traps/"/>
    <updated>2014-05-22T20:08:31+09:00</updated>
    <id>http://todoa2c.github.io/blog/2014/05/22/appengine-python-traps</id>
    <content type="html"><![CDATA[<p>早速いくつかトラップにハマりました。</p>

<h1>requestsパッケージがApp Engineで動かない</h1>

<p>App Engine/Pythonは<a href="https://developers.google.com/appengine/docs/python/urlfetch/?hl=ja">URL Fetch Python API Overview</a>
にあるように、標準ライブラリのurllib, urllib2, httplibであればそのままURL Fetchが使えました。</p>

<p>一方、GitHubのAPIを叩く際に使っていた<a href="https://github.com/sigmavirus24/github3.py">github3.py</a>は
内部的に<a href="https://github.com/kennethreitz/requests">requests</a>ライブラリを使用しているわけですが、
このrequestsライブラリですと、App Engineでは動かないのです。
更にこのrequestsライブラリの中で使われているurllib3はApp Engine内で動くらしいのですが…動かず。無念。</p>

<p>結局他のGitHub APIライブラリを使用しました。</p>

<h1>GoogleAppEngineLauncher.appアップデート後の罠</h1>

<p>GoogleAppEngineLauncher.appアップデート後は、一度は起動しないと最新モジュールが
適用されないみたいです。
私はIntelliJ IDEAを使っており、そのIntelliJ IDEAが参照する<code>google_appengine</code>フォルダは
<code>/usr/local/google_appengine</code> ではなく、GoogleAppEngineLauncher.app内の結構深いところにある
<code>google_appengine</code>フォルダを参照します。</p>

<p>で、GoogleAppEngineLauncher.app がアップデートされたあとは、この <code>google_appengine</code>フォルダが
見当たらないのです。その代わり、google_appengine.zip はある。
一度起動することにより、google_appengine.zipが解凍されて <code>google_appengine</code>フォルダが
作られる模様ですね。。。気づかんわこれ。</p>

<p>こちらからは以上です。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[App Engine用言語をPythonにした件…]]></title>
    <link href="http://todoa2c.github.io/blog/2014/05/16/beginning-appengine-python/"/>
    <updated>2014-05-16T11:19:49+09:00</updated>
    <id>http://todoa2c.github.io/blog/2014/05/16/beginning-appengine-python</id>
    <content type="html"><![CDATA[<h1>はじめに</h1>

<p><a href="http://todoa2c.github.io/blog/2014/02/13/beginning-appengine-go/">GoでGoogle App Engineを触るテスト</a>を
書いておきながら、諸般の事情により、Pythonで書きなおすことにしました。
書き直すと言っても、大した進んでいないので、また1から書き直しという感じですね。</p>

<h2>準備</h2>

<p>今回はMacで開発しているので、ライブラリはここからダウンロードし、インストール＆実行すればOK。</p>

<p><a href="https://developers.google.com/appengine/downloads?hl=ja">Download the Google App Engine SDK &ndash; Google App Engine &ndash; Google Developers</a></p>

<p>Pythonはvirtualenv経由だとうまく動かないもようなので、Pyenvで特定の2.7系バージョンを作る。</p>

<p>開発環境は<a href="http://www.jetbrains.com/idea/">IntelliJ IDEA</a>のPythonプラグイン + App Engineサポートを利用。
間違ってもFlaskを使いたいからと言って、Flask Templateを選んではいけない。あとで自分でライブラリを
ダウンロードすること。そうしなければ、App EngineのライブラリがIntelliJ IDEA側で認識してくれなかった
(別途不具合報告予定)。</p>

<h2>書いてみる</h2>

<p>ライブラリは requirements.txt あたりを用意し、下記コマンドを実行することで、
ライブラリがlibフォルダに置かれる。</p>

<p><code>
pip install -r requirements.txt -t lib
</code></p>

<p>また、appengine_config.py を用意し、上記のlibフォルダをライブラリフォルダとして認識するように、
下記を記述する。</p>

<p><code>
import os
import sys
ROOTPATH = os.path.dirname(__file__)
LIBPATH = os.path.join(ROOTPATH, 'lib')
sys.path.append(LIBPATH)
</code></p>

<p>その他コードは割愛するけれど、Flaskのフレームワークとしての薄さと
3rd-partyライブラリによる拡張性の高さは結構好み。
とは言えDjangoをまじめに学習したことがないので、別途
<a href="http://connpass.com/event/6369/">大阪Pythonユーザの集まり 2014/05</a>の
Djangoセッションで学習してみようかと思う。</p>

<h2>デプロイ</h2>

<p>デプロイは、ローカル＆本番環境ともに、とりあえず簡単に、IntelliJ IDEAから試す。
ローカル環境の場合は、App Engine Serverから起動する事ができる。</p>

<p>本番環境は、メニューのToolsからGoogle App Engine → Upload App Engine app&hellip; から
アップロードできる。簡単。</p>

<p>簡単だけど、継続的デリバリーができなくなるので、別途デプロイ方法を検討する。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[App EngineのDatastoreについて調査中]]></title>
    <link href="http://todoa2c.github.io/blog/2014/02/14/appengine-datastore-references/"/>
    <updated>2014-02-14T17:23:07+09:00</updated>
    <id>http://todoa2c.github.io/blog/2014/02/14/appengine-datastore-references</id>
    <content type="html"><![CDATA[<p>Google App EngineのDatastore周りを学習すべく、いくつか参考にしたサイトをまとめておきます。</p>

<ul>
<li><p><a href="http://www.slideshare.net/devsumi/18c4google-app-engine-6969798">【18-C-4】Google App Engine &ndash; 無限の彼方へ</a></p>

<ul>
<li>Google松尾さんによる資料。2011年と古いが、Datastoreについての概要はここで学べると思う。</li>
</ul>
</li>
<li><p><a href="http://appengine.keicode.com/gae/datastore.php">データストア &ndash; Google App Engine 入門</a></p>

<ul>
<li>Python, Javaの両方について記事がある模様。入門とだけあって分かりやすい気がする。</li>
</ul>
</li>
<li><p><a href="http://proppy-appstats.appspot.com/">Google I/O 2012 &ndash; Optimizing Your Google App Engine App</a></p>

<ul>
<li>つい先程見つけたばかりなので確認中。解説はこちらも見たほうがよいのかな。</li>
<li><a href="http://blog.vier.jp/2013/02/google-app-engine-appengine-ja-night-23.html">Blog @vierjp : 18.Google App Engineパターン (appengine ja night #23)</a></li>
</ul>
</li>
<li><p><a href="https://developers.google.com/appengine/docs/go/datastore/">Go Datastore API &ndash; Google App Engine &ndash; Google Developers</a></p>

<ul>
<li>本家。Go版についてはやっぱりここを見ないと話にならないと思う。キーの設定方法が他のオブジェクト指向言語とどのように違うのかがようやく分かった(あくまで気がするレベル)。</li>
</ul>
</li>
</ul>


<p>まぁ雰囲気だけ掴んだ感じで、まだよく分かってないことが多いです。
土日に実際にDatastoreを使った実装に入ってみようかと思います。</p>

<h1>余談</h1>

<p>余談ですが、何故かF-SecureにGoソースコードのコンパイルをことごとく邪魔されるので、
私物Macで同様の環境を構築しました。
当初の話の通り、いちいちサーバーを再起動せずに変更が追従されるのがいいですね。</p>

<p>思えば私のWindows環境だと、64bit版Goコンパイラがコンパイル直後に落ちるので、
色々おかしいのかもしれないです。
Windows Updateも失敗しまくるし…環境を作り直して1年経ってないのに、また環境の作り直しか…</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GoでGoogle App Engineを触るテスト]]></title>
    <link href="http://todoa2c.github.io/blog/2014/02/13/beginning-appengine-go/"/>
    <updated>2014-02-13T16:50:18+09:00</updated>
    <id>http://todoa2c.github.io/blog/2014/02/13/beginning-appengine-go</id>
    <content type="html"><![CDATA[<h1>はじめに</h1>

<p>Google App Engineを初めて触ることにしました。
しかもみんな大好き<a href="http://golang.org/">プログラミング言語Go</a>で。
ここ最近Gopher Tシャツを着てPythonコードを書くことが多かったので、
リハビリも兼ねつつGoogle App Engineでのスピンアップ最速と言われるGoを
採用することにしました。
以下は作業メモです。</p>

<h2>準備</h2>

<p>開発環境は<a href="https://developers.google.com/appengine/docs/go/gettingstarted/devenvironment">The Development Environment</a>に書かれている。
Goの環境はSDKに含まれているけれど、別途Python 2.7が必要。
ローカルでサーバーを起動するなどで必要らしい。
既にPython 2.7は入れていたので、そのまま次に進む。</p>

<p><a href="https://developers.google.com/appengine/docs/go/gettingstarted/introduction">GAE/g のチュートリアル(英語)</a>を読む。噂に違わず、Goの標準APIで大体の事が書けそうな雰囲気を掴む。</p>

<p><a href="https://developers.google.com/appengine/docs/go/gettingstarted/usingdatastore">Using the Datastore</a>の部分は正直よく分かっていない。</p>

<p>あとはざっと<a href="https://developers.google.com/appengine/docs/go/apis">Go Service APIs</a>にも目を通す。</p>

<h2>書いてみる</h2>

<p>今回作ろうと思ったものは、GitHubに多少絡むものなので、
GitHub APIも使ってみることにする。</p>

<p>幸いGoogleが<a href="https://github.com/google/go-github">go-github</a>を公開しているので、
下記のコマンドで使えるようにする。
go-githubには書かれていなかったが、
go-githubが<a href="https://github.com/google/go-querystring">go-querystring</a>に依存しているようなので、
合わせて入れる。</p>

<p><code>
go get github.com/google/go-github
go get github.com/google/go-querystring
</code></p>

<p>上記で取得できたライブラリを、プロジェクトフォルダと同じ場所に置く。
環境変数GOPATHの参照先に置く、といういつものルールではないことに注意が必要。</p>

<p>実際に、GitHub APIのSearch APIを叩いてみる。
とりあえずgo-githubのサンプル通りに…</p>

<p>```
package front</p>

<p>import (</p>

<pre><code>"github.com/google/go-github/github"
"html/template"
"net/http"
</code></pre>

<p>)</p>

<p>func init() {</p>

<pre><code>http.HandleFunc("/", index)
http.HandleFunc("/find", find)
</code></pre>

<p>}</p>

<p>func index(w http.ResponseWriter, r *http.Request) {</p>

<pre><code>if err := indexTemplate.Execute(w, nil); err != nil {
    http.Error(w, err.Error(), http.StatusInternalServerError)
}
</code></pre>

<p>}</p>

<p>var indexTemplate = template.Must(template.New(&ldquo;index&rdquo;).Parse(indexTemplateHTML))</p>

<p>const indexTemplateHTML = `
<html>
  <body></p>

<pre><code>&lt;form action="/find" method="get"&gt;
  &lt;div&gt;&lt;input type="text" name="q"&gt;&lt;/div&gt;
  &lt;div&gt;&lt;input type="submit" value="Search"&gt;&lt;/div&gt;
&lt;/form&gt;
</code></pre>

<p>  </body>
</html>
`</p>

<p>func find(w http.ResponseWriter, r *http.Request) {</p>

<pre><code>client := github.NewClient(nil)
query := r.FormValue("q")

opts := &amp;github.SearchOptions{Sort: "forks", Order: "desc", ListOptions: github.ListOptions{Page: 1, PerPage: 20}}
res, _, err := client.Search.Repositories(query, opts)

if err != nil {
    http.Error(w, err.Error(), http.StatusInternalServerError)
    return
}

if err := findTemplate.Execute(w, res); err != nil {
    http.Error(w, err.Error(), http.StatusInternalServerError)
}
</code></pre>

<p>}</p>

<p>var findTemplate = template.Must(template.New(&ldquo;find&rdquo;).Parse(findTemplateHTML))</p>

<p>const findTemplateHTML = `
<html>
  <body></p>

<pre><code>&lt;ul&gt;

    &lt;li&gt;&lt;a href=""&gt;&lt;/a&gt;&lt;/li&gt;

&lt;/ul&gt;
</code></pre>

<p>  </body>
</html>
`
```</p>

<p>で、<code>goapp serve</code>によりアプリを起動して、<code>http://localhost:8080/</code>にアクセスして、
いざ検索実行！</p>

<p><code>
Get https://api.github.com/search/repositories?order=desc&amp;page=1&amp;per_page=20&amp;q=abc&amp;sort=forks:
http.DefaultTransport and http.DefaultClient are not available in App Engine.
See https://developers.google.com/appengine/docs/go/urlfetch/overview
</code></p>

<p>ちーん。エラーが返ってきた。
そう言えば<a href="https://developers.google.com/appengine/docs/go/urlfetch/">URL Fetch Go API Overview</a>に、
GAE環境用のHTTP clientを取得する必要があると書かれていたのを思い出す。</p>

<p>で、import文とfind関数を以下のように変更する。
appengine, appengine/urlfetchの2つをimportすることと、
<code>appengine.NewContext(r)</code>でContextなるものを取得し、それを使って<code>urlfetch.Client(c)</code>で
GAE環境用HTTP clientを取得するように変更した。</p>

<p>```
import (</p>

<pre><code>"appengine"
"appengine/urlfetch"
"github.com/google/go-github/github"
"html/template"
"net/http"
</code></pre>

<p>)</p>

<p>func find(w http.ResponseWriter, r *http.Request) {</p>

<pre><code>// 下記の2行でApp Engine上でURL Fetchができる
c := appengine.NewContext(r)  
client := github.NewClient(urlfetch.Client(c))

query := r.FormValue("q")

opts := &amp;github.SearchOptions{Sort: "forks", Order: "desc", ListOptions: github.ListOptions{Page: 1, PerPage: 20}}
res, _, err := client.Search.Repositories(query, opts)

if err != nil {
    http.Error(w, err.Error(), http.StatusInternalServerError)
    return
}

if err := findTemplate.Execute(w, res); err != nil {
    http.Error(w, err.Error(), http.StatusInternalServerError)
}
</code></pre>

<p>}
```</p>

<p>これで何とか動いた。
このくらいの内容であれば、あまり困らずにGoで書けることに驚き。</p>

<h2>デプロイ</h2>

<p>デプロイは事前に<a href="https://appengine.google.com/">Applications Overview</a>で
アプリケーションを登録しておき、app.yamlのアプリケーション名と名前を合わせて(よく分かってない)、
<code>goapp deploy</code>コマンドでデプロイできる。</p>

<p>私は2段階認証を使っているので、事前にデプロイ用の固有パスワードを取得しておいた。</p>

<p>デプロイは割とあっさり完了し、普通にGAE/Go環境が本番環境でも動いている。凄い…
次はDatastoreまわりを学んでいこうっと。</p>

<h2>分からない点</h2>

<ul>
<li>appengine.NewContextとは？</li>
<li>go-githubのSearchOptionsの詳細</li>
<li>Datastore</li>
<li>スケジュール実行</li>
<li>GAE/gに適したフレームワークってあるのかしら？</li>
<li>関係ないけどそろそろシンタックスハイライトをこのブログでも使いたい</li>
<li>これまた関係ないけどF-SecureがひたすらWebアプリの実行を邪魔してツラい。</li>
</ul>

]]></content>
  </entry>
  
</feed>
